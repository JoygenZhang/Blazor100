## Blazor组件自做三 : 使用JS隔离封装signature_pad签名组件 ##

#### 1. 在文件夹wwwroot/lib,添加zxing子文件夹,里面下载库文件(文件文末源码里可复制) qrcode.min.js和zxing.min.js复制到此文件夹. 最终版本参考如下

```
+zxing
  |-qrcode.min.js
  |-zxing.min.js
```
![zxing](https://user-images.githubusercontent.com/8428709/159175463-386b9bee-e14f-45bd-8642-b704692cc15d.jpg)

#### 2. 添加zxingjs.js文件

```
+zxing
  |-zxingjs.js
```

<details>
<summary>zxingjs.js代码</summary>

```


```
</details>

#### 3. 前面两篇文章主要在于快速入手建立组件, 基本没有解释代码. 现在开始穿插一点Blazor和JS交互的相关知识.

##### 3.1 打开Day1的Pages/ViewerPage.razor文件,顶端有一句 @page "/viewer" , 意思是此页面的路由地址为viewer,请求此路径就会加载到此页面/组件.

[参考阅读:ASP.NET Core Blazor 路由和导航](https://docs.microsoft.com/zh-cn/aspnet/core/blazor/fundamentals/routing?view=aspnetcore-6.0)

同理,Pages/HandwrittenPage.razor文件的 @page "/handwritten" 也是一样作用

![QQ截图20220320173304](https://user-images.githubusercontent.com/8428709/159175736-29b29558-9864-4be6-ab2d-f9a390b97474.jpg)


##### 3.2 调用组件演示页面代码逐行说明

``` 
<Viewerjs Images="imagesList" /> 直接调用Viewerjs组件,Images是组件的参数,打开文件Components/Viewerjs.razor可以查看定义
``` 

```     
    /// <summary>
    /// 图片列表
    /// </summary>
    [Parameter] public List<string> Images { get; set; } = new List<string>();

``` 


-----
    @page "/viewer"  //页面的路由地址

    <Viewerjs Images="imagesList" /> //调用Viewerjs组件,指定组件图片列表数据来源

    @code{
        List<string>? imagesList;

        protected override void OnInitialized() //组件初始化 , [参考阅读:组件生命周期](https://docs.microsoft.com/zh-cn/aspnet/core/blazor/components/lifecycle?view=aspnetcore-6.0)
        {
            //生成演示图片数据

            imagesList = new List<string>();
            if (!imagesList.Any())
            {
                for (int i = 1; i <= 9; i++)
                {
                    imagesList.Add($"https://fengyuanchen.github.io/viewerjs/images/thumbnails/tibet-{i}.jpg");
                }
            }
        }

    }
-----

##### 3.3 组件生命周期

[参考阅读:组件生命周期](https://docs.microsoft.com/zh-cn/aspnet/core/blazor/components/lifecycle?view=aspnetcore-6.0)
 
![QQ截图20220320175545](https://user-images.githubusercontent.com/8428709/159175510-74697d4f-aa91-4177-bdf1-f54365b02259.jpg)


##### 3.4 调整演示工程外观

现在Pages/Index.razor已经直接放置了两个占用空间比较大的组件,再加入今天的组件势必很难看,我们将对首页以及左侧导航菜单做一些调整,以便条理更加清晰.

删除Pages/Index.razor文件中以下代码

``` 
<ViewerPage />
 
<hr />

<HandwrittenPage />
```
![QQ截图20220320172953](https://user-images.githubusercontent.com/8428709/159175678-a5efc5bd-0b4b-4be2-b7ba-075d217cdee9.jpg)


打开Shared/NavMenu.razor添加相关导航,NavLink组件是Blazor默认自带导航组件, [参考阅读:NavLink 类](https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.components.routing.navlink?view=aspnetcore-6.0)

```
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="viewer">
                <span class="oi oi-plus" aria-hidden="true"></span> 图片浏览
            </NavLink>
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="handwritten">
                <span class="oi oi-plus" aria-hidden="true"></span> 手写签名
            </NavLink>
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="barcodescanner">
                <span class="oi oi-plus" aria-hidden="true"></span> 条码扫描
            </NavLink>
        </div>

```

![QQ截图20220320173050](https://user-images.githubusercontent.com/8428709/159175693-fd2d317b-d6dd-4d6f-a1a6-79107c1f1f5d.jpg)


#### 5. 打开Components文件夹 , 新建BarcodeScanner.razor组件

[参考阅读:Blazor JS 互操作](https://docs.microsoft.com/zh-cn/aspnet/core/blazor/javascript-interoperability/?view=aspnetcore-6.0)

[参考阅读:JS 模块中的 JS 隔离](https://docs.microsoft.com/zh-cn/aspnet/core/blazor/javascript-interoperability/call-javascript-from-dotnet?view=aspnetcore-6.0#javascript-isolation-in-javascript-modules)  

##### 5.1 C#组件实例封装
```
DotNetObjectReference.Create(this)
```

##### 5.2 C#标记JS调用的函数[JSInvokable("invokeFromJS")] 
```
    [JSInvokable("invokeFromJS")] 
    public async Task ChangeValue(string val)
    {
        Result = val;
        StateHasChanged();
        await ScanResult.InvokeAsync(val);
    }
```

##### 5.3 zxingjs.js文件
```
import '/lib/zxing/zxing.min.js' //模块的方式加载zxing库

//定义一个函数init供blazor组件调用

export function init(autostop, wrapper, options) {}  //wrapper为blazor组件的实例 

//扫码结果通过blazor组件的实例调用DotNet.invokeMethodAsync实现

wrapper.invokeMethodAsync("invokeFromJS", result.text);

```

##### 5.4 C#动态载入JS模块 

```
private IJSObjectReference? module;

module = await JS.InvokeAsync<IJSObjectReference>("import", "./lib/zxing/zxingjs.js");

```

##### 5.5 C#调用JS函数

```
module.InvokeVoidAsync("init", true, DotNetObjectReference.Create(this), null);
```

##### 5.6 完整代码

<details>
<summary>BarcodeScanner.razor代码</summary>

```


```
</details>


##### 6. Pages文件添加BarcodeScannerPage.razor文件,用于演示组件调用.


<details>
<summary>BarcodeScannerPage.razor代码</summary>

```


```
</details>

#### 7. _Imports.razor加入一行引用组件的命名空间,已经有这行就不需要再重复写了.
```
@using Blazor100.Components
``` 

#### 8. 首页引用组件演示页 `<BarcodeScannerPage />`或者Shared/NavMenu.razor添加导航

```
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="barcodescanner">
                <span class="oi oi-plus" aria-hidden="true"></span> 条码扫描
            </NavLink>
        </div>
```

#### 9. F5运行程序


## 至此,使用JS隔离封装ZXing扫码组件大功告成! Happy coding!

##### Blazor组件自做系列 

  [Blazor组件自做一 : 使用JS隔离封装viewerjs库](D1.Viewer.md)

  [Blazor组件自做二 : 使用JS隔离制作手写签名组件](D2.Handwritten.md)
  
  [Blazor组件自做三 : 使用JS隔离封装ZXing扫码](D3.BarcodeScanner.md)
  
  [Blazor组件自做四: 使用JS隔离封装signature_pad签名组件](D4.SignaturePad.md)

  Blazor组件自做五: 使用JS隔离封装Google地图

  Blazor组件自做六: 使用JS隔离封装Baidu地图

  Blazor组件自做七: 使用JS隔离制作定位/持续定位组件

  Blazor组件自做八: 使用JS隔离封装屏幕键盘kioskboard.js组件

##### 项目源码 [Github](https://github.com/densen2014/Blazor100) | [Gitee](https://gitee.com/densen2014/Blazor100)
